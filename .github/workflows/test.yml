name: pruebas en Docker

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Instalar dependencias
        run: npm install

      - name: Ejecutar pruebas con reporte
        run: npm test -- --reporter=junit --outputFile=test-results.xml

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results.xml
          retention-days: 30

      - name: Publish Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Test Results
          path: test-results.xml
          reporter: jest-junit

      # -----------------------------
      # ðŸ“ˆ Cobertura de Pruebas (MÃ©tricas)
      # -----------------------------
      - name: Ejecutar cobertura
        run: npm run coverage

      - name: Subir reporte de cobertura
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage
          retention-days: 30

      - name: Generar resumen de cobertura en summary
        run: |
          echo "## ðŸ“ˆ Coverage Summary" >> $GITHUB_STEP_SUMMARY
          LINES=$(jq '.total.lines.pct' coverage/coverage-summary.json)
          FUNCTIONS=$(jq '.total.functions.pct' coverage/coverage-summary.json)
          STATEMENTS=$(jq '.total.statements.pct' coverage/coverage-summary.json)
          BRANCHES=$(jq '.total.branches.pct' coverage/coverage-summary.json)
          echo "- Lines: $LINES%" >> $GITHUB_STEP_SUMMARY
          echo "- Functions: $FUNCTIONS%" >> $GITHUB_STEP_SUMMARY
          echo "- Statements: $STATEMENTS%" >> $GITHUB_STEP_SUMMARY
          echo "- Branches: $BRANCHES%" >> $GITHUB_STEP_SUMMARY

  docker:
    runs-on: ubuntu-latest
    needs: test
    outputs:
      docker-summary: ${{ steps.docker-summary.outputs.summary }}
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v4

      - name: Login en Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.Docker_Username }}
          password: ${{ secrets.Docker_Password }}

      - name: Extraer metadatos de Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.Docker_Username }}/miapp
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Construir y subir imagen a Docker Hub
        id: build-push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Generate Docker Summary
        id: docker-summary
        run: |
          echo "## ðŸ³ Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Repository: ${{ secrets.Docker_Username }}/miapp" >> $GITHUB_STEP_SUMMARY
          echo "- Tags: ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "- Size: $(docker images ${{ secrets.Docker_Username }}/miapp --format "{{.Size}}" | head -1)" >> $GITHUB_STEP_SUMMARY
          echo "- Build Status: âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "- Platform: $(uname -m)" >> $GITHUB_STEP_SUMMARY
          echo "- Pushed to: Docker Hub" >> $GITHUB_STEP_SUMMARY

  summary:
    runs-on: ubuntu-latest
    needs: [test, docker]
    steps:
      - name: Generate Final Summary
        run: |
          echo "# ðŸ“Š Workflow Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Tests ejecutados y resultados subidos" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ˆ Coverage Summary" >> $GITHUB_STEP_SUMMARY
          # Se aÃ±ade automÃ¡ticamente desde el job test
          echo "## ðŸ³ Docker Build" >> $GITHUB_STEP_SUMMARY
          echo "- Imagen construida y publicada en Docker Hub" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“… Execution Time" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow completado en: $(date -u)" >> $GITHUB_STEP_SUMMARY
